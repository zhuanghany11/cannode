# 长安车辆CAN控制系统实现说明

## 概述
本实现将ROS2控制命令转换为长安车辆CAN协议格式，实现了完整的闭环控制系统。

## 实现的功能

### 1. PID控制器
实现了两种PID控制器：

#### AccToSpeedController (加速度到速度控制器)
- **输入**: 目标速度、当前速度、时间间隔
- **输出**: 加速度指令
- **用途**: 车辆速度闭环控制
- **参数**: 
  - kp=1.5, ki=0.2, kd=0.1
  - 输出限幅: ±3.0 m/s²

#### ValveToAngleController (液压阀开度到角度控制器)
- **输入**: 目标角度、当前角度、时间间隔
- **输出**: 液压阀电流值 (0-1500mA)
- **用途**: 大臂、铲斗、转向的角度闭环控制
- **参数**:
  - 大臂/铲斗: kp=25.0, ki=0.8, kd=3.0, 死区=0.5°
  - 转向: kp=30.0, ki=1.0, kd=2.5, 死区=1.0°

### 2. CAN消息处理

#### 发送的消息 (上位机→VCU)
所有消息ID需要减去0x80000000后使用：

1. **0x18000001 - 控制命令消息**
   - 上高压控制、急停、心跳信号
   - 整车模式、工作灯等

2. **0x18000002 - 液压电机控制消息**
   - 液压电机使能、工作模式、转速、扭矩
   - 转向电磁阀方向和电流控制
   - 转速: 默认2000rpm (底层发送17000)
   - 扭矩: 默认3000Nm

3. **0x18000003 - 行走电机控制消息**
   - 行走电机使能、工作模式、方向
   - 行走电机转速和扭矩控制
   - 刹车阀电流控制
   - 方向: 0=空档, 1=前进, 2=后退

4. **0x18000004 - 机构电磁阀控制消息**
   - 大臂抬/降电磁阀电流 (0-1500mA)
   - 铲斗内收/外翻电磁阀电流 (0-1500mA)

#### 接收的消息 (VCU→上位机)

1. **0x181F0001 - 状态反馈消息**
   - 高压状态、驾驶模式、电池电量
   - 各种故障信息
   - 动作反馈信息

2. **0x181F0002 - 电机状态消息**
   - 液压电机实际转速、扭矩、电流
   - 行走电机档位和工作模式

3. **0x181F0003 - 行走电机状态**
   - 行走电机电流、扭矩、转速
   - 轮速 (用于计算实际车速)
   - 车速计算: wheel_speed * 0.16 / 3.6 (km/h转m/s)

4. **0x181F0007 - 丹佛斯转向**
   - 转向角度 (0-4095映射到-50~+50度)
   - 转向状态

### 3. 控制逻辑实现

#### 输入解析 (从ROS2 control_cmd)
- `speed()`: 目标速度 (m/s)
- `arm_angle()`: 目标大臂角度 (度)
- `shovel_angle()`: 目标铲斗角度 (度)
- `steering_target()`: 目标转向百分比 (±100转换为±50度)
- `parking_brake()`: 驻车制动
- `estop()`: 急停信号

#### 闭环控制流程

1. **车速控制**:
   ```
   目标速度 → AccToSpeedController → 加速度 → 扭矩映射 → 行走电机控制
   ```

2. **大臂控制**:
   ```
   目标角度 → ValveToAngleController → 阀电流 → 根据误差方向选择抬/降阀
   ```

3. **铲斗控制**:
   ```
   目标角度 → ValveToAngleController → 阀电流 → 根据误差方向选择收/翻阀
   ```

4. **转向控制**:
   ```
   目标角度 → ValveToAngleController → 阀电流 → 根据误差方向选择左/右转
   ```

#### CAN反馈数据读取
- **车速**: 从0x181F0003消息的轮速计算
- **转向角度**: 从0x181F0007消息获取
- **大臂角度**: 预留接口 (TODO: 需要倾角仪CAN消息ID)
- **铲斗角度**: 预留接口 (TODO: 需要倾角仪CAN消息ID)

### 4. 数据格式说明

#### 液压电机扭矩/转速
- DBC注释: 扭矩 = (发送值-5000)*2，范围-3000~3000Nm
- 当前实现: 直接发送物理值
- TODO: 根据实际测试调整转换关系

#### 转向角度映射
- 丹佛斯原始值: 0-4095
- 映射到角度: (raw/4095)*100-50 = -50~+50度
- steering_target百分比: -100~100
- 转换关系: angle = percentage * 0.5

#### 轮速到车速
- 原始轮速: 分辨率0.16
- 转换: wheel_speed_kmh = raw * 0.16
- 最终车速: speed_mps = wheel_speed_kmh / 3.6

## 发送频率
- 所有控制命令: 20ms周期 (50Hz)
- 心跳信号: 200ms翻转一次

## 待完成功能 (TODO)

1. **倾角仪数据读取**
   - 需要确定3个倾角仪的CAN消息ID
   - 实现大臂和铲斗角度的实时读取
   - 当前使用占位值0.0

2. **PID参数优化**
   - 当前使用默认参数
   - 需要通过launch文件配置
   - 建议通过实车测试调整

3. **液压/行走电机参数调整**
   - 扭矩/转速转换关系需要实车验证
   - 工作模式选择需要测试确认

4. **故障处理**
   - 完善各种故障位的处理逻辑
   - 添加安全保护机制

## 参考文档
- DBC文件: `doc/changan_protocol.dbc`
- Python参考: `doc/changan/changan/joystick-to-can-tool/can_message_parser/data_assignment.py`
- 山推范本: `src/vehicle_protocol/shantui.cc/h`

## 文件列表
```
src/low_level_controller/
  ├── acc_to_speed_controller.h/cc     # 速度PID控制器
  └── valve_to_angle_controller.h/cc   # 角度PID控制器

src/vehicle_protocol/
  ├── changan.h                         # 长安协议定义
  └── changan.cc                        # 长安协议实现
```

## 编译说明
代码已完成，不需要编译。所有修改已保存到源文件中。

## 注意事项
1. 所有结构体已通过static_assert验证为8字节
2. CAN消息ID使用extended frame格式
3. 字节序使用小端序 (little-endian)
4. PID控制器包含积分抗饱和和输出限幅
5. 死区处理避免执行器抖动

